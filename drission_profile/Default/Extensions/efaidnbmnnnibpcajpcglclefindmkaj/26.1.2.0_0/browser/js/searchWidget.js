/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{events as e}from"../../common/analytics.js";import{dcLocalStorage as t}from"../../common/local-storage.js";import{util as i}from"./content-util.js";import{updateExtUserState as s}from"../../common/util.js";import{OptionsPageSource as r}from"../../common/constant.js";import{offscreenConfig as n}from"./offscreen/offscrenUtil.js";import{SETTINGS as o}from"../../sw_modules/settings.js";await t.init();class a{constructor(e){this.widget=e}sendToMain(e,t=!1){const s=this.cleanMessage(e);i.messageToMain(s),t||"dismiss"===e.content_op||"resize_window"===e.content_op||"external_msg"===e.main_op||this.widget.dismiss()}cleanMessage(e){const t={...e};return delete t.click_context,delete t.newUI,delete t.analytics,delete t.is_viewer,delete t.reload_in_native,!0===t.authenticatedPDF&&delete t.authenticatedPDF,t}handleExternalMessage(e){try{const t=this.widget.state.currentRequest.frictionless_uri;if(!t)return;const s=new URL(t);if(e.origin===s.origin){let t=!1;if(e.data&&"dc_hosted_event"===e.data.content_op&&e.data.dc_hosted_event&&"upload-error"===e.data.dc_hosted_event.event){t=!0;const s=e.data.dc_hosted_event;let r=s.error;r=s.file&&s.file.name?`"${s.file.name}" ${i.getTranslation("frictionlessWidgetErrorUnsupportedFormat")}`:"string"==typeof s.error?s.error:s.error&&s.error.message?s.error.message:i.getTranslation("frictionlessWidgetErrorUploadFailed"),this.sendToMain({main_op:"relay_to_content",content_op:"show_error_toast",error_message:r},!0)}this.sendToMain({main_op:"external_msg",data:e.data,timeStamp:Date.now()},t)}}catch(e){}}}class c{constructor(e){this.widget=e}clearTimer(){this.widget.state.timer&&(clearTimeout(this.widget.state.timer),this.widget.state.timer=null);const e=document.querySelector(".acrobatMainDiv");e&&(o.IS_ERP_READER?e.style.display="none":e.style.opacity="1.0")}setTimer(){if(!this.widget.state.timer&&!this.widget.state.timerOff){const e=this.widget.state.currentRequest?.is_pdf?this.widget.config.PDF_MENU_TIME:this.widget.config.MENU_TIME;this.widget.state.timer=setTimeout(()=>{this.fadeAway()},e)}}fadeAway(){this.widget.state.timer=null;const e=document.querySelector(".acrobatMainDiv");e&&(e.style.transition=`opacity ${this.widget.config.FADE_TIME}ms ease-in-out`,e.style.opacity="0",setTimeout(()=>{this.widget.dismiss()},this.widget.config.FADE_TIME))}resetUI(){i.translateElements(".translate");const e=document.getElementById("action_message");e&&(e.textContent="")}prepareWidgetScreen(){const e=document.querySelector(".acrobatMainDiv");e&&(e.classList.remove("home-screen"),e.classList.add("widget-screen-main-div"));const t=document.querySelector(".actions");t&&t.classList.add("hidden")}showIframe(e){const t=document.querySelector(".frictionless-container");t&&(t.classList.remove("hidden"),t.appendChild(e));const i=document.querySelector(".frictionless-host");i&&i.classList.remove("hidden");const s=document.querySelector(".frictionless-loader");s&&s.classList.add("hidden")}hideSpinner(){const e=document.querySelector(".frictionless-container");e&&e.classList.remove("hidden");const t=document.querySelector(".frictionless-loader");t&&t.classList.add("hidden")}showError(e,t){const i=document.querySelector(".error-title");i&&(i.textContent=e);const s=document.querySelector(".error-details");s&&(s.textContent=t);const r=document.querySelector(".frictionless-error");r&&r.classList.remove("hidden"),this.widget.messageHandler.sendToMain({content_op:"resize_window",panel_op:"load-frictionless",main_op:"relay_to_content"})}hideError(){const e=document.querySelector(".frictionless-error");e&&e.classList.add("hidden"),this.widget.messageHandler.sendToMain({content_op:"resize_window",panel_op:"load-frictionless",main_op:"relay_to_content"})}showOfflineUI(){const e=document.querySelector(".frictionless-container");e&&e.classList.add("hidden");const t=document.querySelector(".frictionless-loader");t&&t.classList.add("hidden");const s=document.querySelector(".frictionless-error");s&&s.classList.add("hidden");const r=document.querySelector(".frictionless-offline-ui");r&&r.remove();const n=`\n            <div class="frictionless-offline-ui">\n                <div class="offline-icon">\n                    <img src="../images/no_connection.svg" alt="No connection" />\n                </div>\n                <div class="offline-title">${i.getTranslation("frictionlessWidgetNoConnectionTitle")}</div>\n                <div class="offline-message">${i.getTranslation("popupOfflineMessage")}</div>\n            </div>\n        `,o=document.querySelector(".frictionless-host");o&&(o.insertAdjacentHTML("afterbegin",n),o.classList.remove("hidden")),this.widget.messageHandler.sendToMain({content_op:"resize_window",panel_op:"load-frictionless",main_op:"relay_to_content"})}hideOfflineUI(){const e=document.querySelector(".frictionless-offline-ui");e&&e.remove();const t=document.querySelector(".frictionless-host");t&&t.classList.add("hidden")}showErrorUI(e,t){const s=document.querySelector(".frictionless-container");s&&s.classList.add("hidden");const r=document.querySelector(".frictionless-loader");r&&r.classList.add("hidden");const n=document.querySelector(".frictionless-error-ui");n&&n.remove();const o=`\n            <div class="frictionless-error-ui">\n                <div class="error-icon">\n                    <svg width="48" height="48" viewBox="0 0 48 48" fill="none">\n                        <circle cx="24" cy="24" r="20" stroke="#E34850" stroke-width="2"/>\n                        <line x1="24" y1="16" x2="24" y2="28" stroke="#E34850" stroke-width="2" stroke-linecap="round"/>\n                        <circle cx="24" cy="34" r="1.5" fill="#E34850"/>\n                    </svg>\n                </div>\n                <div class="error-ui-title">${e}</div>\n                <div class="error-ui-message">${t}</div>\n                <button class="error-retry-btn">${i.getTranslation("frictionlessWidgetRetryButton")}</button>\n            </div>\n        `,a=document.querySelector(".frictionless-host");if(a){a.insertAdjacentHTML("afterbegin",o),a.classList.remove("hidden");const e=a.querySelector(".error-retry-btn");e&&e.addEventListener("click",()=>{this.widget.offlineManager.retryLoadContent()})}this.widget.messageHandler.sendToMain({content_op:"resize_window",panel_op:"load-frictionless",main_op:"relay_to_content"})}hideErrorUI(){const e=document.querySelector(".frictionless-error-ui");e&&e.remove();const t=document.querySelector(".frictionless-host");t&&t.classList.add("hidden")}}class d{constructor(e){this.widget=e}createIframe(e){const t=document.createElement("iframe");t.setAttribute("referrerpolicy","no-referrer"),t.classList.add("frictionless-iframe");const i=this.buildIframeUrl(e);return this.setupIframeEvents(t,e),t.setAttribute("src",i),t}buildIframeUrl(e){if(!e.frictionless_uri)throw new Error("frictionless_uri is required to build iframe URL");if(!e.pdf_action)throw new Error("pdf_action is required to build iframe URL");this.widget.state.currentRequest={...this.widget.state.currentRequest,...e};const i=new URL(e.frictionless_uri);if(i.hash){let t=i.hash.substring(1);t.endsWith("/")||(t+="/"),t+=e.pdf_action,i.hash=t}else{let t=i.pathname;t.endsWith("/")||(t+="/"),t+=e.pdf_action,i.pathname=t}const s={workflow:e.frictionless_workflow,dropzone2:"true",useExtensionStorage:!0,locale:this.getLocale(),showHeader:!1,showFooter:!0,theme:this.widget.state.theme},r=new URLSearchParams;Object.keys(s).forEach(e=>{r.append(e,s[e])}),"false"===t.getItem("logAnalytics")&&r.append("app!analytics","disable"),"test"!==e.env&&"stage"!==e.env||r.append("app!versions","latest");const n=i.hash.substring(1),o=n.includes("?")?"&":"?";return i.hash=`${n}${o}${r.toString()}`,i.toString()}getLocale(){return this.widget.state.appLocale||this.widget.state.currentRequest?.locale||chrome.i18n.getMessage("@@ui_locale")}setupIframeEvents(t,s){let r,n=!1;t.onerror=t=>{n=!0,clearTimeout(r),console.error("SearchWidget: Iframe onerror event fired",t),this.widget.analytics.track(e.FRICTIONLESS_WIDGET_LOADING_FAILED,{error_type:"iframe_onerror",error_message:t?.message||"unknown"});const s=document.querySelector(".frictionless-loader");s&&s.classList.add("hidden"),this.widget.uiManager.showErrorUI(i.getTranslation("frictionlessWidgetErrorUnableToLoad"),i.getTranslation("frictionlessWidgetErrorLoadFailed"))},t.onload=()=>{n=!0,clearTimeout(r),this.widget.messageHandler.sendToMain({iframe_onload_time:Date.now(),main_op:"timing_info",timing_op:"startup_to_iframe_load"},!0);try{this.sendMessageToIframe(t,{valid:!0},s)}catch(e){console.error("SearchWidget: Error posting message to iframe",e)}},r=setTimeout(()=>{if(!n){const s=document.querySelectorAll(".frictionless-iframe"),r=document.querySelector(".frictionless-container");if(console.error("SearchWidget: Iframe load timeout",{iframeInDom:s.length,iframeSrc:t.src,navigatorOnline:navigator.onLine,containerVisible:r&&!r.classList.contains("hidden")}),this.widget.analytics.track(e.FRICTIONLESS_WIDGET_LOADING_FAILED,{error_type:"timeout",timeout_ms:this.widget.config.IFRAME_LOAD_TIMEOUT}),navigator.onLine){const e=document.querySelector(".frictionless-loader");e&&e.classList.add("hidden");document.querySelectorAll(".frictionless-iframe").forEach(e=>e.remove()),this.widget.uiManager.showErrorUI(i.getTranslation("frictionlessWidgetErrorTimeout"),i.getTranslation("frictionlessWidgetErrorTimeoutMessage"))}else this.widget.offlineManager.handleOffline()}},this.widget.config.IFRAME_LOAD_TIMEOUT),this.widget.messageHandler.sendToMain({iframe_call_time:Date.now(),main_op:"timing_info"},!0)}getCurrentIframe(){const e=document.querySelectorAll(".frictionless-iframe");return 1===e.length?e[0]:null}sendMessageToIframe(e,t,i){const s=i?.frictionless_uri||this.widget.state.currentRequest.frictionless_uri;if(!s)return void console.warn("No frictionless_uri available for iframe message");const r=new URL(s);e.contentWindow.postMessage(t,r.origin)}}class l{constructor(e){this.widget=e}track(e,t={}){const s={main_op:"analytics",analytics:[[e,t]]};i.messageToMain(s)}}class h{constructor(e){this.widget=e,this.pendingRequest=null}setupOfflineDetection(){window.addEventListener("online",()=>this.handleOnline()),window.addEventListener("offline",()=>this.handleOffline()),navigator.onLine||(this.widget.state.isOnline=!1)}handleOffline(){this.widget.state.isOnline=!1,this.widget.analytics.track(e.FRICTIONLESS_WIDGET_OFFLINE),this.widget.state.currentRequest?.frictionless_uri&&(this.pendingRequest={...this.widget.state.currentRequest});const t=document.querySelectorAll(".frictionless-iframe"),i=document.querySelector(".frictionless-loader"),s=i&&null!==i.offsetParent;(t.length>0||s)&&this.widget.uiManager.showOfflineUI()}handleOnline(){this.widget.state.isOnline=!0,this.widget.analytics.track(e.FRICTIONLESS_WIDGET_ONLINE),this.widget.uiManager.hideOfflineUI(),this.widget.uiManager.hideErrorUI(),this.pendingRequest&&this.retryLoadContent()}retryLoadContent(){if(this.widget.state.isOnline&&this.pendingRequest&&this.pendingRequest.frictionless_uri)try{const t=document.querySelector(".frictionless-loader");t&&t.classList.remove("hidden");const s=document.querySelector(".frictionless-offline-ui");s&&s.remove();const r=document.querySelector(".frictionless-error-ui");r&&r.remove();document.querySelectorAll(".frictionless-iframe").forEach(e=>e.remove());const n=document.querySelector(".frictionless-container");n&&(n.innerHTML="");const o=document.querySelector(".frictionless-host");o&&o.classList.add("hidden");try{this.widget.uiManager.prepareWidgetScreen();const e=this.widget.iframeManager.createIframe(this.pendingRequest);this.widget.uiManager.showIframe(e),this.pendingRequest=null}catch(t){console.error("SearchWidget: Failed to create iframe",t),this.widget.analytics.track(e.FRICTIONLESS_WIDGET_LOADING_FAILED,{error_type:"retry_iframe_creation_failed",error_message:t?.message||"unknown"});const s=document.querySelector(".frictionless-loader");s&&s.classList.add("hidden"),this.widget.uiManager.showErrorUI(i.getTranslation("frictionlessWidgetErrorLoading"),i.getTranslation("frictionlessWidgetErrorGeneric"))}}catch(t){console.error("SearchWidget: Retry failed",t),this.widget.analytics.track(e.FRICTIONLESS_WIDGET_LOADING_FAILED,{error_type:"retry_failed",error_message:t?.message||"unknown"});const s=document.querySelector(".frictionless-loader");s&&s.classList.add("hidden"),this.widget.uiManager.showErrorUI(i.getTranslation("frictionlessWidgetErrorLoading"),i.getTranslation("frictionlessWidgetErrorGeneric"))}}}new class{constructor(){this.state={initialized:!1,currentRequest:{frictionless_uri:"",pdf_action:"",frictionless_workflow:"",env:"prod",locale:"en",variant:"v1"},timer:null,timerOff:!1,appLocale:t.getItem("appLocale"),isOnline:navigator.onLine,theme:this.detectTheme()},this.config={MENU_TIME:1500,PDF_MENU_TIME:3e3,FADE_TIME:1500,IFRAME_LOAD_TIMEOUT:6e3,ERROR_TOOLTIP_DURATION:5e3,SKELETON_MIN_DURATION:1500,FADE_TRANSITION_DURATION:300},this.messageHandler=new a(this),this.uiManager=new c(this),this.iframeManager=new d(this),this.analytics=new l(this),this.offlineManager=new h(this),this.init()}detectTheme(){const e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";return this.applyThemeToBody(e),e}applyThemeToBody(e){document.body.setAttribute("data-theme",e)}async init(){this.state.initialized||(this.state.initialized=!0,this.initializeTranslations(),this.setupEventListeners(),this.setupMessageHandling(),this.setupThemeDetection(),this.offlineManager.setupOfflineDetection(),this.handleInitialRequest())}initializeTranslations(){i.translateElements(".translate");const e=i.getTranslation("loadingStatus"),t=document.querySelector(".frictionless-loader");t&&t.setAttribute("data-loading-title",e)}setupThemeDetection(){if(!window.matchMedia)return;const e=window.matchMedia("(prefers-color-scheme: dark)"),t=e=>{const t=e.matches?"dark":"light";this.state.theme=t,this.handleThemeChange(t)};e.addEventListener?e.addEventListener("change",t):e.addListener&&e.addListener(t)}handleThemeChange(e){this.applyThemeToBody(e);const t=this.iframeManager.getCurrentIframe();if(t&&t.contentWindow)try{this.iframeManager.sendMessageToIframe(t,{type:"theme-change",theme:e},this.state.currentRequest)}catch(e){console.error("SearchWidget: Error sending theme change to iframe",e)}}getAcrobatOnlineUrl(){const e=this.state.currentRequest.env||"prod";return`${(n[e]||n.prod).acrobat_viewer_origin}?x_api_client_location=frictionless:header_redirect&x_api_client_id=dc-chrome-extension`}setupEventListeners(){const t=document.querySelector(".close-dialog"),i=document.querySelector(".settings-dialog"),s=document.querySelector(".acrobat-branding"),r=document.querySelector(".action-available-click"),n=document.querySelector(".acrobatMainDiv"),o=document.querySelector(".sign-out"),a=document.querySelector(".do-acro-prefs");t&&t.addEventListener("click",()=>{n&&n.classList.contains("widget-screen-main-div")&&this.analytics.track(e.FRICTIONLESS_WIDGET_CROSS_CLICKED),this.dismiss()}),i&&i.addEventListener("click",()=>this.openSettingsPage()),s&&s.addEventListener("click",()=>{this.analytics.track(e.FRICTIONLESS_WIDGET_HEADER_CLICKED);const t=this.getAcrobatOnlineUrl();window.open(t,"_blank")}),r&&r.addEventListener("click",()=>{this.uiManager.clearTimer(),this.analytics.track(e.TREFOIL_ACROBAT_LABEL_CLICKED),this.messageHandler.sendToMain({main_op:"go_to_aonline",verb:"acrobat_label"})}),n&&(n.addEventListener("mouseenter",()=>this.uiManager.clearTimer()),n.addEventListener("mouseleave",()=>this.uiManager.setTimer())),o&&o.addEventListener("click",()=>{this.uiManager.clearTimer(),this.analytics.track(e.SIGN_OUT_CLICKED),this.messageHandler.sendToMain({main_op:"sign-out"})}),a&&a.addEventListener("click",()=>{this.analytics.track(e.TREFOIL_HTML_PREFERENCES_CLICK),this.messageHandler.sendToMain({main_op:"showConversionSettingsDialog"})})}setupMessageHandling(){i.addMainListener(e=>this.handleMessage(e)),window.addEventListener("message",e=>this.messageHandler.handleExternalMessage(e),!1)}handleInitialRequest(){if(window.location.search)try{const t=new URLSearchParams(window.location.search).get("message");if(!t)throw new Error('Missing required "message" parameter');const i=JSON.parse(decodeURIComponent(t));if(!i||"object"!=typeof i)throw new Error("Invalid request data format");if(o.TEST_MODE&&window.addEventListener("message",e=>this.handleMessage(e.data),!1),document.body.classList.add("desktop-app-reader"),"html_menu"===i.panel_op){const t=document.querySelector(".acrobatMainDiv");t&&t.classList.add("home-screen"),this.analytics.track(e.FRICTIONLESS_HOME_SCREEN_SHOWN)}this.processRequest(i)}catch(t){console.error("SearchWidget: Failed to parse initial request:",t),this.analytics.track(e.FRICTIONLESS_WIDGET_LOADING_FAILED,{error_type:"url_parse_failed",error_message:t?.message||"unknown"}),this.uiManager.showErrorUI(i.getTranslation("frictionlessWidgetErrorUnableToLoad"),i.getTranslation("frictionlessWidgetErrorInitFailed"))}else console.warn("SearchWidget: No query parameters found")}handleMessage(e){this.isValidMessage(e)&&(this.state.currentRequest={...this.state.currentRequest,...e,tabId:this.state.currentRequest?.tabId||e.tabId},this.state.timerOff=!1,this.uiManager.clearTimer(),this.uiManager.resetUI(),this.processRequest(e))}isValidMessage(e){return(!this.state.currentRequest?.tabId||!e.tabId||e.tabId===this.state.currentRequest.tabId)&&void 0!==e.panel_op}processRequest(e){const t=e.panel_op;switch(delete e.panel_op,t){case"load-frictionless":this.handleLoadFrictionless(e);break;case"show-frictionless-error":this.handleShowError(e);break;case"clear-frictionless-error":this.handleClearError();break;case"send-external-msg":this.handleSendExternalMessage(e);break;default:console.warn("Unknown panel operation:",t)}this.uiManager.setTimer()}handleLoadFrictionless(t){if(this.state.timerOff=!0,this.state.currentRequest={...this.state.currentRequest,...t},"resize_window"===t.content_op)return;if(t.hide_spinner)return void this.uiManager.hideSpinner();const r=document.querySelector(".frictionless-container");if(r&&0===r.children.length){if(this.uiManager.prepareWidgetScreen(),"search"===t.frictionless_workflow&&s(),!this.state.isOnline)return this.offlineManager.pendingRequest=t,this.uiManager.showOfflineUI(),void this.analytics.track(e.FRICTIONLESS_WIDGET_OFFLINE);try{const e=this.iframeManager.createIframe(t);this.uiManager.showIframe(e)}catch(s){console.error("SearchWidget: Failed to create iframe",s),this.analytics.track(e.FRICTIONLESS_WIDGET_LOADING_FAILED,{error_type:"iframe_creation_failed",error_message:s?.message||"unknown",variant:t.variant}),this.uiManager.showErrorUI(i.getTranslation("frictionlessWidgetErrorUnableToLoad"),i.getTranslation("frictionlessWidgetErrorInitFailed"))}}}handleShowError(e){e.error_title&&e.error_description&&this.uiManager.showError(e.error_title,e.error_description)}handleClearError(){this.uiManager.hideError()}handleSendExternalMessage(e){try{const t=this.iframeManager.getCurrentIframe();t&&(this.iframeManager.sendMessageToIframe(t,e.data,e),delete e.data)}catch(e){console.error("Failed to send external message:",e)}this.state.timerOff=!0}openSettingsPage(){this.analytics.track(e.TREFOIL_SETTINGS_ICON_CLICKED),t.setItem("optionsPageSource",r.FRICTIONLESS_WIDGET_SETTINGS),chrome.runtime.openOptionsPage(()=>{chrome.runtime.lastError&&this.analytics.track(e.TREFOIL_SETTINGS_FAILED_TO_OPEN)})}dismiss(){if(!chrome.runtime?.id)return void(document.body.style.display="none");const e=document.querySelector(".acrobatMainDiv");e&&(e.style.opacity="0",e.style.height="0",e.style.overflow="hidden"),this.messageHandler.sendToMain({forced_cancel:!0,content_op:"dismiss",main_op:"relay_to_content"})}};