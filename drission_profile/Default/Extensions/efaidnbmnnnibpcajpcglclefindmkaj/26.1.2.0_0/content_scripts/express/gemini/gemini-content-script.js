/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
class GeminiContentScript{responseImageTagName="SINGLE-IMAGE";previewedImageTagName="mat-dialog-content";imageTagName="img";responseContainerTagName="response-container";messageActionsTagName="MESSAGE-ACTIONS";immersivePanelTagName="annotated-multimedia-panel";immersivePanelImageTagName="interactive-diagram";buttonsContainerV2ClassName="buttons-container-v2";spacerClassName="spacer";arrowBackContainerClassName="arrow-back-container";generatedImageExpansionDialogActionButtonsClassName="generated-image-expansion-dialog-action-buttons";cdkOverlayPopoverClassName="cdk-overlay-popover cdk-global-overlay-wrapper";immersivePanelActionButtonsClassName="action-buttons";hoverTouchpointId="gemini-hover-adobe-express-entry-point";previewEntryPointId="gemini-preview-adobe-express-entry-point";immersivePanelEntryPointId="gemini-immersive-panel-adobe-express-entry-point";touchpoint="geminiPreview";hoverTouchpoint="geminiChatView";immersivePanelTouchpoint="geminiImmersivePanel";hoverTooltips=[];geminiExpressStateKey="geminiExpressState";launchExpress=(e,t,s)=>{chrome.runtime.sendMessage({main_op:"launch-express",imgUrl:e,intent:s,touchpoint:t})};async loadContentScripts(){const e=chrome.runtime.getURL("content_scripts/express/single-click-cta.js"),t=chrome.runtime.getURL("content_scripts/express/express-utils.js"),s=await Promise.all([import(e),import(t)]);this.ExpressCTAClass=s[0].default,this.expressUtils=s[1].default,this.expressCTA=new this.ExpressCTAClass}floatingButtonClickHandler=(e,t)=>{if(!chrome?.runtime?.id)return void this.removeAllTouchpoints();const s=t.getElementsByTagName(this.imageTagName)[0];if(!s)return void this.expressUtils.sendErrorLog("Error executing express in Gemini hover","image element not found");const i=s.src;i?(this.setTouchpointClickedForFteState(this.hoverTouchpoint),this.launchExpress(i,this.hoverTouchpoint,e)):this.expressUtils.sendErrorLog("Error executing express in Gemini hover","image URL not found")};createAndAttachHoverButton=async e=>{const t=e.closest(this.responseContainerTagName);if(!t)return;if(this.expressUtils.getElementsFromClassNames(t,"cc440d50ba-express-entrypoint-button")[0])return;const s=e.getElementsByTagName(this.imageTagName)[0];if(!s)return;if(0!==e.getElementsByClassName(this.hoverTouchpoint).length)return;const i=new this.ExpressCTAClass,n=await i.renderMenuButton(e=>{this.floatingButtonClickHandler(e,t)},this.hoverTouchpoint);if(n.id=this.hoverTouchpointId,t.getElementsByTagName(this.imageTagName).length>1)return;const r=this.messageActionsTagName,o=t.getElementsByTagName(r)[0];if(!o)return;const a=this.buttonsContainerV2ClassName,m=o.getElementsByClassName(a)[0];if(!m)return;if("true"===t.getAttribute("express_processing"))return;t.setAttribute("express_processing","true");const l=m.getElementsByClassName(this.spacerClassName)[0];let c=0;if(m.children.length>0){for(const e of m.children){if(e.classList.contains(this.spacerClassName))break;c+=e.offsetWidth}0!==s.offsetWidth?(l?.before(n),n.style.position="relative",n.style.left=16+s.offsetWidth-(c+n.offsetWidth)+"px",this.hoverTooltips.push(i.attachTooltip("bottom")),t.removeAttribute("express_processing"),this.expressUtils.sendAnalyticsEventOncePerDay([["DCBrowserExt:Express:Gemini:ChatViewEntryPoint:Shown"]])):t.removeAttribute("express_processing")}else t.removeAttribute("express_processing")};previewEntryPointClickHandler=e=>{if(!chrome?.runtime?.id)return void this.removeAllTouchpoints();const t=document.getElementsByTagName(this.previewedImageTagName)[0];if(!t)return void this.expressUtils.sendErrorLog("Error executing express in Gemini preview","preview container not found");const s=t.getElementsByTagName(this.imageTagName)[0];s?(this.setTouchpointClickedForFteState(this.touchpoint),this.launchExpress(s.src,this.touchpoint,e)):this.expressUtils.sendErrorLog("Error executing express in Gemini preview","image element not found")};immersivePanelEntryPointClickHandler=e=>{if(!chrome?.runtime?.id)return void this.removeAllTouchpoints();const t=document.getElementsByTagName(this.immersivePanelImageTagName)[0];if(!t)return void this.expressUtils.sendErrorLog("Error executing express in Gemini immersive panel","immersive panel container not found");const s=t.getElementsByTagName(this.imageTagName)[0];s?(this.setTouchpointClickedForFteState(this.immersivePanelTouchpoint),this.launchExpress(s.src,this.touchpoint,e)):this.expressUtils.sendErrorLog("Error executing express in Gemini immersive panel","image element not found")};addThumbnailAndImagePreviewerObserver=()=>{new MutationObserver(()=>{this.messageAreaObserverHandler(),this.imagePreviewerObserverHandler()}).observe(document.body,{childList:!0,subtree:!0})};addPreviewEntryPoint=async e=>{const t=e.parentElement;if(!t)return;const s=t.getElementsByClassName(this.arrowBackContainerClassName)[0];if(!s)return;if(document.getElementById(this.previewEntryPointId))return;const i=await this.expressCTA.renderMenuButton(this.previewEntryPointClickHandler,this.touchpoint);i.id=this.previewEntryPointId;const n=this.generatedImageExpansionDialogActionButtonsClassName,r=s.getElementsByClassName(n)[0];r?.before(i,s.lastChild),this.tooltip=this.expressCTA.attachTooltip("bottom"),chrome.runtime.sendMessage({main_op:"reRenderShowOneChild"}),this.expressUtils.sendAnalyticsEventOncePerDay([["DCBrowserExt:Express:Gemini:PreviewEntryPoint:Shown"]]);const o=document.getElementsByClassName(this.cdkOverlayPopoverClassName)[0];o&&o.setAttribute("popover","auto")};addImmersivePanelEntryPoint=async e=>{const t=e.getElementsByClassName(this.immersivePanelActionButtonsClassName)[0];if(!t)return;if(document.getElementById(this.immersivePanelEntryPointId))return;const s=await this.expressCTA.renderMenuButton(this.immersivePanelEntryPointClickHandler,this.immersivePanelTouchpoint);s.id=this.immersivePanelEntryPointId,t.before(s),this.tooltip=this.expressCTA.attachTooltip("bottom"),chrome.runtime.sendMessage({main_op:"reRenderShowOneChild"}),this.expressUtils.sendAnalyticsEventOncePerDay([["DCBrowserExt:Express:Gemini:ImmersivePanelEntryPoint:Shown"]])};setTouchpointClickedForFteState=async e=>{this.removeContextualFte();let t=await chrome.storage.local.get(this.geminiExpressStateKey);switch(t=t?.geminiExpressState?t.geminiExpressState:{},e){case this.touchpoint:t.previewTouchpointUsed=!0;break;case this.hoverTouchpoint:t.hoverTouchpointUsed=!0;break;case this.immersivePanelTouchpoint:t.immersivePanelTouchpointUsed=!0}chrome.storage.local.set({[this.geminiExpressStateKey]:t})};messageAreaObserverHandler=()=>{if(!this.config.enableGeminiHoverExpressMenu)return;if(!chrome?.runtime?.id)return void this.removeAllTouchpoints();this.removeTooltipIfFteRendered();const e=document.getElementsByTagName(this.responseImageTagName);if(0!==e.length)for(const t of e)this.createAndAttachHoverButton(t)};imagePreviewerObserverHandler=()=>{if(!this.config.enableGeminiPreviewExpressMenu)return;if(!chrome?.runtime?.id)return void this.removeAllTouchpoints();this.removeTooltipIfFteRendered();const e=document.getElementsByTagName(this.previewedImageTagName)[0];e&&this.addPreviewEntryPoint(e)};immersivePanelObserverHandler=()=>{if(!this.config.enableGeminiImmersivePanelExpressMenu)return;if(!chrome?.runtime?.id)return void this.removeAllTouchpoints();this.removeTooltipIfFteRendered();const e=document.getElementsByTagName(this.immersivePanelTagName)[0];e&&this.addImmersivePanelEntryPoint(e)};removeAllTouchpoints=()=>{const e=this.expressUtils.getElementsFromClassNames(document,"cc440d50ba-express-entrypoint-button");for(const t of e)t.remove()};cleanupTooltips=()=>{this.tooltip?.tooltip?.remove(),this.tooltip=null;for(const e of this.hoverTooltips)e?.tooltip?.remove();this.hoverTooltips=[]};removeTooltipIfFteRendered=()=>{document.getElementById("express-contextual-fte")&&this.cleanupTooltips()};removeContextualFte=()=>{const e=document.getElementById("express-contextual-fte");e&&e.remove()};init=async()=>{const e=await chrome.runtime.sendMessage({main_op:"gemini-express-init"});this.config=e,(this.config.enableGeminiPreviewExpressMenu||this.config.enableGeminiImmersivePanelExpressMenu||this.config.enableGeminiHoverExpressMenu)&&(this.responseImageTagName=this.config.selectors?.responseImageTagName||this.responseImageTagName,this.previewedImageTagName=this.config.selectors?.previewedImageTagName||this.previewedImageTagName,this.responseContainerTagName=this.config.selectors?.responseContainerTagName||this.responseContainerTagName,this.messageActionsTagName=this.config.selectors?.messageActionsTagName||this.messageActionsTagName,this.immersivePanelTagName=this.config.selectors?.immersivePanelTagName||this.immersivePanelTagName,this.immersivePanelImageTagName=this.config.selectors?.immersivePanelImageTagName||this.immersivePanelImageTagName,this.buttonsContainerV2ClassName=this.config.selectors?.buttonsContainerV2ClassName||this.buttonsContainerV2ClassName,this.spacerClassName=this.config.selectors?.spacerClassName||this.spacerClassName,this.arrowBackContainerClassName=this.config.selectors?.arrowBackContainerClassName||this.arrowBackContainerClassName,this.generatedImageExpansionDialogActionButtonsClassName=this.config.selectors?.generatedImageExpansionDialogActionButtonsClassName||this.generatedImageExpansionDialogActionButtonsClassName,this.cdkOverlayPopoverClassName=this.config.selectors?.cdkOverlayPopoverClassName||this.cdkOverlayPopoverClassName,this.immersivePanelActionButtonsClassName=this.config.selectors?.immersivePanelActionButtonsClassName||this.immersivePanelActionButtonsClassName,await this.loadContentScripts(),this.addThumbnailAndImagePreviewerObserver())}}const geminiContentScript=new GeminiContentScript;geminiContentScript.init();