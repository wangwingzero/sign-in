# v4.0.0 使用说明（浏览帖子 + 签到）

这份文档只回答 3 件事：
1. 你要输入什么
2. 脚本按什么顺序执行
3. 失败后怎么补救

---

## 1. 先看结论：你至少要填什么

### 必填（用于 NewAPI 自动签到）
- `LINUXDO_ACCOUNTS`

> 没有这个，NewAPI 自动 OAuth 无法运行。

最小可用示例（单账号）：
```json
[
  {
    "username": "your_linuxdo_email",
    "password": "your_linuxdo_password",
    "name": "主账号"
  }
]
```

多账号示例（v4.0.0 推荐）：
```json
[
  {
    "username": "account_a@example.com",
    "password": "password_a",
    "name": "主账号"
  },
  {
    "username": "account_b@example.com",
    "password": "password_b",
    "name": "小号"
  }
]
```

字段说明：

| 字段 | 必填 | 说明 |
|---|---|---|
| `username` | ✅ | LinuxDO 用户名/邮箱 |
| `password` | ✅ | LinuxDO 密码 |
| `name` | ❌ | 日志显示名，建议填写，便于区分 |
| `cookies` | ❌ | LinuxDO Cookie（可选，优先于账号密码） |
| `browse_minutes` | ❌ | 仅 LinuxDO 浏览流程使用（默认 20） |
| `checkin_sites` | ❌ | 指定要签到的 NewAPI 站点列表（白名单），不设置则签到全部。见 `000/可用站点列表.md` |
| `exclude_sites` | ❌ | 排除指定站点（黑名单），不设置则不排除。如 `["wong", "elysiver"]` |

#### checkin_sites 用法

指定后只签到列表中的站点，不指定则签到全部可用站点（默认行为）：
```json
[
  {
    "username": "your_email@example.com",
    "password": "your_password",
    "name": "主账号",
    "checkin_sites": ["anyrouter", "kfcapi", "duckcoding", "runanytime", "hotaru"]
  },
  {
    "username": "second@example.com",
    "password": "password",
    "name": "小号"
  }
]
```

> **注意**：anyrouter 需要手动加入 `checkin_sites`（如果你使用了白名单）。它有独立签到 API，不加入则不会被签到。

> 站点 ID 大小写不敏感。完整的可用站点 ID 对照表见 `000/可用站点列表.md`（每次运行后自动更新）。

### 可选（用于加速签到）
- `NEWAPI_ACCOUNTS`

作用：作为 seed cookie 优先尝试，命中后更快；失效会自动回退到缓存/OAuth。

示例：
```json
[
  {
    "name": "WONG主号",
    "provider": "wong",
    "cookies": { "session": "xxx" },
    "api_user": "12345"
  },
  {
    "name": "KFC主号",
    "provider": "kfcapi",
    "cookies": { "session": "yyy" },
    "api_user": "67890"
  }
]
```

字段说明：

| 字段 | 必填 | 说明 |
|---|---|---|
| `provider` | ✅ | 站点 ID（如 `wong`/`kfcapi`/`hotaru` 等） |
| `cookies.session` | ✅ | 该站点的 session |
| `api_user` | ✅ | 用户 ID |
| `name` | ❌ | 显示名，建议填写 |

---

## 2. 执行顺序（重点）

## A. LinuxDO 浏览流程（`linuxdo-browse.yml`）
1. 读取 `LINUXDO_ACCOUNTS`
2. 按账号逐个登录 LinuxDO
3. 按配置执行浏览行为
4. 推送通知（如果配置了通知渠道）

定时（北京时间）：`0:00 / 8:00 / 16:00`

## B. NewAPI 签到流程（`newapi-daily-check-in.yml`）

### v4.0.0 的关键行为
- **多账号串行**：账号 1 跑完整站点列表后，再跑账号 2。
- 不是“按站点切账号”，而是“按账号跑全站”。

### 每个账号、每个站点的执行优先级
1. 先试 `NEWAPI_ACCOUNTS` seed cookie（如果有该 provider）
2. 再试本地缓存 cookie（历史成功缓存）
3. 再走浏览器 OAuth（共享会话优先）
4. 共享会话不通时，回退逐站独立浏览器 OAuth
5. 成功后自动回写缓存，并导出最新账号快照

定时（北京时间）：`8:00 / 20:00`

---

## 3. 运行后你会看到什么文件

NewAPI 工作流常见输出：
- `run_newapi.log`：主日志
- `scripts/chrome_extension/failed_sites.json`：失败站点清单
- `签到账户/NEWAPI_ACCOUNTS.json`：运行后导出的最新账号快照
- `debug_screenshots/`：仅 debug 模式下生成

---

## 4. 失败怎么处理（实操版）

常见报错与处理：

| 日志关键词 | 常见原因 | 建议处理 |
|---|---|---|
| `HTTP 401` / `HTTP 403` | cookie 失效、会话过期 | 走人工补录刷新 cookie |
| `provider_login_navigate 超时(45s)` | 目标站点加载慢/网络抖动/CF 阻断 | 重跑 + 人工打开站点登录 |
| `OAuth 登录失败，无法获取 session` | OAuth 中断或页面状态异常 | 人工登录后用扩展提取 |

### 人工补录标准流程
1. 打开扩展 `scripts/chrome_extension`
2. 刷新失败清单或导入邮件附件 `failed_sites.json`
3. 一键打开失败站点并手工登录
4. 回扩展点击“提取失败站点 Cookie”
5. 复制生成结果更新 `NEWAPI_ACCOUNTS`

### v4.0.0 新增（独立附加工具）
扩展里增加了独立入口：
- **JSON 配置合并工具（独立页面）**
- 支持：
  - 一次导入多个 JSON 文件
  - 分批多次导入（累计追加）
  - 合并去重（按 `provider + api_user`）

适合你这种“多个账号、多个补录文件（合集1/合集2）”场景。

---

## 5. 本地运行命令

```bash
# 安装依赖
uv sync

# 只跑 NewAPI 签到
uv run python main.py --platform newapi

# 只跑 LinuxDO 浏览
uv run python main.py --platform linuxdo

# 两者都跑
uv run python main.py
```

调试模式：
```bash
uv run python main.py --platform newapi --debug
```

快速测试单个站点（通过环境变量覆盖 checkin_sites）：
```bash
CHECKIN_SITES_OVERRIDE=anyrouter uv run python main.py --platform newapi --debug
```
GitHub Actions 手动触发时也可以在 `checkin_sites` 输入框中填写（逗号分隔）。

---

## 6. 通知配置（可选）

常用通知：
- 邮件：`EMAIL_USER` / `EMAIL_PASS` / `EMAIL_TO`
- PushPlus：`PUSHPLUS_TOKEN`
- Telegram：`TELEGRAM_BOT_TOKEN` / `TELEGRAM_CHAT_ID`
- Gotify：`GOTIFY_URL` / `GOTIFY_TOKEN`

不配通知也可以正常跑，只是不会推送结果。

---

## 7. 推荐配置策略（直接照抄）

- 只有 1 个 LinuxDO 账号：
  - 只配 `LINUXDO_ACCOUNTS` 也能跑（自动模式）
- 多个 LinuxDO 账号：
  - 在 `LINUXDO_ACCOUNTS` 填多个账号，系统会按账号串行跑全站
- 想提升成功率/速度：
  - 同时维护 `NEWAPI_ACCOUNTS`，作为 seed 加速与兜底
- 出现失败站点：
  - 用扩展补录 + 独立 JSON 合并工具整合后再回填 Secret

---

如果你只想“最少输入马上跑”：
- 先只填 `LINUXDO_ACCOUNTS`
- 跑一轮后，失败的再用扩展补录回填 `NEWAPI_ACCOUNTS`

这就是当前版本最稳的流程。
