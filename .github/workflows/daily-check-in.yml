name: Multi-Platform Daily Check-in

on:
  schedule:
    - cron: '0 0,12 * * *'  # 每天 2 次（UTC 0点和12点，即北京时间 8点和20点）

  workflow_dispatch:
    inputs:
      platform:
        description: '指定平台 (留空运行所有)'
        required: false
        type: choice
        options:
          - ''
          - linuxdo
          - newapi

jobs:
  checkin:
    runs-on: ubuntu-22.04
    permissions:
      actions: write
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      # 安装 uv
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      
      # 设置 Python
      - name: Set up Python
        run: uv python install 3.12
      
      # 安装依赖
      - name: Install dependencies
        run: uv sync
      
      # 安装 Xvfb 虚拟显示（用于绕过 Cloudflare 的 headless 检测）
      - name: Install Xvfb and Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb google-chrome-stable
      
      # 安装 Patchright 浏览器（备用）
      - name: Install Patchright browsers
        run: uv run patchright install chromium
      
      # 执行签到（使用 xvfb-run 模拟显示器）
      - name: Execute multi-platform check-in
        env:
          # 浏览器引擎配置
          # nodriver: 不基于 WebDriver，直接使用 CDP，最难被检测（推荐）
          # drissionpage: 不基于 WebDriver，较难被 Cloudflare 检测
          # patchright: 反检测 Chromium（备用）
          BROWSER_ENGINE: nodriver
          DISPLAY: ":99"
          
          # NewAPI 站点统一配置（支持所有 NewAPI 架构的站点）
          # JSON 格式: [{"name": "账号名", "provider": "站点ID", "cookies": {"session": "xxx"}, "api_user": "123"}]
          # 支持的 provider: anyrouter, wong, elysiver, kfcapi, duckcoding, runanytime, neb, zeroliya, mitchll 等
          NEWAPI_ACCOUNTS: ${{ secrets.NEWAPI_ACCOUNTS }}
          
          # 兼容旧配置（如果设置了 ANYROUTER_ACCOUNTS 也会被读取）
          ANYROUTER_ACCOUNTS: ${{ secrets.ANYROUTER_ACCOUNTS }}
          
          # WONG 公益站配置
          WONG_ACCOUNTS: ${{ secrets.WONG_ACCOUNTS }}
          
          # LinuxDO 统一账号配置
          LINUXDO_ACCOUNTS: ${{ secrets.LINUXDO_ACCOUNTS }}
          
          # 通知配置 - Email
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
          CUSTOM_SMTP_SERVER: ${{ secrets.CUSTOM_SMTP_SERVER }}
          
          # 通知配置 - Gotify
          GOTIFY_URL: ${{ secrets.GOTIFY_URL }}
          GOTIFY_TOKEN: ${{ secrets.GOTIFY_TOKEN }}
          GOTIFY_PRIORITY: ${{ secrets.GOTIFY_PRIORITY }}
          
          # 通知配置 - Server酱³
          SC3_PUSH_KEY: ${{ secrets.SC3_PUSH_KEY }}
          
          # 通知配置 - wxpush
          WXPUSH_URL: ${{ secrets.WXPUSH_URL }}
          WXPUSH_TOKEN: ${{ secrets.WXPUSH_TOKEN }}
          
          # 通知配置 - Telegram
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_USERID: ${{ secrets.TELEGRAM_USERID }}
          
          # 通知配置 - PushPlus
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
          
          # 通知配置 - Server酱 (旧版)
          SERVERPUSHKEY: ${{ secrets.SERVERPUSHKEY }}
          
          # 通知配置 - 钉钉
          DINGDING_WEBHOOK: ${{ secrets.DINGDING_WEBHOOK }}
          
          # 通知配置 - 飞书
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
          
          # 通知配置 - 企业微信
          WEIXIN_WEBHOOK: ${{ secrets.WEIXIN_WEBHOOK }}
          
          # 通知配置 - Bark
          BARK_KEY: ${{ secrets.BARK_KEY }}
          BARK_SERVER: ${{ secrets.BARK_SERVER }}
        run: |
          # 使用 xvfb-run 启动，模拟显示器绕过 Cloudflare headless 检测
          if [ -n "${{ github.event.inputs.platform }}" ]; then
            xvfb-run --server-args="-screen 0 1920x1080x24" uv run python main.py --platform ${{ github.event.inputs.platform }}
          else
            xvfb-run --server-args="-screen 0 1920x1080x24" uv run python main.py
          fi


      # 清理旧的工作流运行记录
      - name: Delete workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 10
          keep_minimum_runs: 6
