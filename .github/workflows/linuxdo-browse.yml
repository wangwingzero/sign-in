name: LinuxDO Browse & Check-in

on:
  schedule:
    # 每天 2 次：避开 CF 高防护时段（北京 08:00-14:00）
    # UTC 16 = 北京 00:00 | UTC 22 = 北京 06:00
    - cron: '0 16,22 * * *'

  workflow_dispatch:
    inputs:
      debug_mode:
        description: '启用调试模式（显示更多日志）'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  browse:
    runs-on: ubuntu-22.04
    permissions:
      actions: write
      contents: read
    
    steps:
      - uses: actions/checkout@v4

      # 安装 uv
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "0.8.15"

      # 设置 Python
      - name: Set up Python
        run: uv python install 3.12

      # 安装依赖
      - name: Install dependencies
        run: uv sync

      # 安装 Xvfb 虚拟显示和 Chrome（用于绕过 Cloudflare 的 headless 检测）
      - name: Install Xvfb and Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb google-chrome-stable
          # 验证 Chrome 安装
          google-chrome-stable --version

      # 安装 Patchright 浏览器（备用）
      - name: Install Patchright browsers
        run: uv run patchright install chromium

      # 执行 LinuxDO 浏览签到
      - name: Execute LinuxDO browse
        env:
          # 浏览器引擎配置
          BROWSER_ENGINE: nodriver
          DISPLAY: ":99"
          
          # LinuxDO 账号配置
          LINUXDO_ACCOUNTS: ${{ secrets.LINUXDO_ACCOUNTS }}
          
          # 通知配置
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
          CUSTOM_SMTP_SERVER: ${{ secrets.CUSTOM_SMTP_SERVER }}
          GOTIFY_URL: ${{ secrets.GOTIFY_URL }}
          GOTIFY_TOKEN: ${{ secrets.GOTIFY_TOKEN }}
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          
          # 调试模式
          DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}
        run: |
          # 启动 Xvfb 虚拟显示
          Xvfb :99 -screen 0 1920x1080x24 &
          sleep 2
          echo "DISPLAY=$DISPLAY"
          
          # 执行 LinuxDO 浏览脚本
          uv run python linuxdo_browse.py

      # 清理旧的工作流运行记录
      - name: Delete workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 7
          keep_minimum_runs: 5
