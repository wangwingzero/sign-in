name: NewAPI Daily Check-in

on:
  schedule:
    - cron: '0 0,12 * * *'  # 每天 2 次（UTC 0点和12点，即北京时间 8点和20点）

  workflow_dispatch:
    inputs:
      platform:
        description: '指定平台（留空运行全部）'
        required: false
      checkin_sites:
        description: '仅签到指定站点（逗号分隔，如 anyrouter,kfcapi，留空=按配置）'
        required: false
      debug:
        description: '开启 Debug 模式（截图+详细日志）'
        required: false
        type: boolean
        default: false

jobs:
  checkin:
    runs-on: ubuntu-22.04
    permissions:
      actions: write
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # 安装 uv
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "0.8.15"
      
      # 设置 Python
      - name: Set up Python
        run: uv python install 3.12
      
      # 安装依赖
      - name: Install dependencies
        run: uv sync
      
      # 安装 Xvfb 虚拟显示（用于绕过 Cloudflare 的 headless 检测）
      - name: Install Xvfb and Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb google-chrome-stable
      
      # 安装 Patchright 浏览器（备用）
      - name: Install Patchright browsers
        run: uv run patchright install chromium
      
      # 恢复 Cookie 缓存（OAuth 成功后自动保存的 Cookie，下次直接用 Cookie+API 更快）
      - name: Restore cookie cache
        uses: actions/cache@v4
        with:
          path: |
            .newapi_cookies
            .newapi_accounts_override.json
            .newapi_failure_tracker.json
          key: newapi-cookies-${{ github.run_id }}
          restore-keys: |
            newapi-cookies-
      
      # 执行签到（使用 xvfb-run 模拟显示器）
      - name: Execute multi-platform check-in
        env:
          # 浏览器引擎配置
          # nodriver: 不基于 WebDriver，直接使用 CDP，最难被检测（推荐）
          # drissionpage: 不基于 WebDriver，较难被 Cloudflare 检测
          # patchright: 反检测 Chromium（备用）
          BROWSER_ENGINE: nodriver
          BROWSER_HEADLESS: "false"
          DISPLAY: ":99"
          
          # 站点过滤（手动触发时可指定仅签到某些站点，加速调试）
          CHECKIN_SITES_OVERRIDE: ${{ github.event.inputs.checkin_sites || '' }}

          # 连续失败跳过阈值（连续失败 N 次后自动跳过该站点，默认 3）
          FAILURE_THRESHOLD: ${{ secrets.FAILURE_THRESHOLD || '3' }}

          # Debug 模式（设置为 true 开启截图和详细日志）
          # DEBUG: "true"
          NEWAPI_DEBUG: ${{ github.event.inputs.debug || 'false' }}
          DEBUG: ${{ github.event.inputs.debug || 'false' }}
          DEBUG_MODE: ${{ github.event.inputs.debug || 'false' }}

          # NEWAPI 导出/邮件（导出文件默认供 artifact 与邮件附件使用）
          NEWAPI_ACCOUNTS_EXPORT_FILE: 签到账户/NEWAPI_ACCOUNTS.json
          NEWAPI_EXPORT_EMAIL_ENABLED: "true"
          NEWAPI_EXPORT_EMAIL_SUBJECT: NewAPI 运行后账号快照（NEWAPI_ACCOUNTS）

          # Cloudflare 参数（可通过环境变量在代码中读取）
          # 经验：首轮等待更久，后续短超时+刷新，降低误判和抖动
          NEWAPI_CF_MAX_RETRIES: "5"
          NEWAPI_CF_TIMEOUT_FIRST: "45"
          NEWAPI_CF_TIMEOUT_RETRY: "30"
          NEWAPI_CF_RETRY_DELAYS: "6,18,30,45"
          OAUTH_SITE_TIMEOUT_SHARED: "180"
          OAUTH_SITE_TIMEOUT_FALLBACK: "220"
          
          # LinuxDO 账户（必填 - 自动模式只需要这个！）
          # JSON 格式: [{"username": "email", "password": "pass", "name": "显示名"}]
          # 自动模式：只配这个，系统自动遍历所有站点 OAuth 签到，无需手动配置每个站点
          LINUXDO_ACCOUNTS: ${{ secrets.LINUXDO_ACCOUNTS }}
          
          # NewAPI 站点手动配置（可选 - 不配则自动模式）
          # 如果设置了，使用预配置的 Cookie 签到（更快，不需要浏览器）
          # 如果不设置，自动用 LINUXDO_ACCOUNTS 通过 OAuth 登录所有站点
          # JSON 格式: [{"name": "账号名", "provider": "站点ID", "cookies": {"session": "xxx"}, "api_user": "123"}]
          NEWAPI_ACCOUNTS: ${{ secrets.NEWAPI_ACCOUNTS }}
          
          # 兼容旧配置（如果设置了 ANYROUTER_ACCOUNTS 也会被读取）
          ANYROUTER_ACCOUNTS: ${{ secrets.ANYROUTER_ACCOUNTS }}
          
          # WONG 公益站配置
          WONG_ACCOUNTS: ${{ secrets.WONG_ACCOUNTS }}
          
          # 通知配置 - Email
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
          CUSTOM_SMTP_SERVER: ${{ secrets.CUSTOM_SMTP_SERVER }}
          
          # 通知配置 - Gotify
          GOTIFY_URL: ${{ secrets.GOTIFY_URL }}
          GOTIFY_TOKEN: ${{ secrets.GOTIFY_TOKEN }}
          GOTIFY_PRIORITY: ${{ secrets.GOTIFY_PRIORITY }}
          
          # 通知配置 - Server酱³
          SC3_PUSH_KEY: ${{ secrets.SC3_PUSH_KEY }}
          
          # 通知配置 - wxpush
          WXPUSH_URL: ${{ secrets.WXPUSH_URL }}
          WXPUSH_TOKEN: ${{ secrets.WXPUSH_TOKEN }}
          
          # 通知配置 - Telegram
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_USERID: ${{ secrets.TELEGRAM_USERID }}
          
          # 通知配置 - PushPlus
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
          
          # 通知配置 - Server酱 (旧版)
          SERVERPUSHKEY: ${{ secrets.SERVERPUSHKEY }}
          
          # 通知配置 - 钉钉
          DINGDING_WEBHOOK: ${{ secrets.DINGDING_WEBHOOK }}
          
          # 通知配置 - 飞书
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
          
          # 通知配置 - 企业微信
          WEIXIN_WEBHOOK: ${{ secrets.WEIXIN_WEBHOOK }}
          
          # 通知配置 - Bark
          BARK_KEY: ${{ secrets.BARK_KEY }}
          BARK_SERVER: ${{ secrets.BARK_SERVER }}
        run: |
          set -o pipefail
          RUN_DEBUG="${{ github.event.inputs.debug || 'false' }}"
          EXTRA_ARGS=""
          if [ "$RUN_DEBUG" = "true" ]; then
            EXTRA_ARGS="--debug"
            echo "[debug] manual debug mode enabled"
            echo "[debug] engine=$BROWSER_ENGINE headless=$BROWSER_HEADLESS display=$DISPLAY"
            echo "[debug] cf retries=$NEWAPI_CF_MAX_RETRIES first=$NEWAPI_CF_TIMEOUT_FIRST retry=$NEWAPI_CF_TIMEOUT_RETRY delays=$NEWAPI_CF_RETRY_DELAYS"
          fi
          # 使用 xvfb-run 启动，模拟显示器绕过 Cloudflare headless 检测
          # 只运行 newapi 签到，不运行 LinuxDO 浏览（浏览帖子用 linuxdo-browse.yml）
          if [ -n "${{ github.event.inputs.platform }}" ]; then
            xvfb-run --server-args="-screen 0 1920x1080x24" uv run python main.py --platform ${{ github.event.inputs.platform }} $EXTRA_ARGS 2>&1 | tee run_newapi.log
          else
            xvfb-run --server-args="-screen 0 1920x1080x24" uv run python main.py --platform newapi $EXTRA_ARGS 2>&1 | tee run_newapi.log
          fi

      - name: Append runtime summary
        if: always()
        run: |
          {
            echo "## NewAPI Runtime Summary"
            echo
            if grep -q "AUTO_OAUTH_SUMMARY:" run_newapi.log; then
              echo '```json'
              grep "AUTO_OAUTH_SUMMARY:" run_newapi.log | tail -n 1 | sed 's/.*AUTO_OAUTH_SUMMARY: //'
              echo '```'
            else
              echo "AUTO_OAUTH_SUMMARY not found."
            fi
            echo
            if [ -f scripts/chrome_extension/failed_sites.json ]; then
              echo "### Failed Sites Report"
              echo '```json'
              # 避免在 YAML 缩进脚本里使用 heredoc，防止 EOF/分隔符缩进导致语法错误
              python -c "import json; from pathlib import Path; p=Path('scripts/chrome_extension/failed_sites.json'); data=json.loads(p.read_text(encoding='utf-8')); print(json.dumps({'generated_at': data.get('generated_at'), 'failed_count': data.get('failed_count', 0), 'sample': (data.get('failed_sites') or [])[:5]}, ensure_ascii=False, indent=2))"
              echo '```'
            else
              echo "### Failed Sites Report"
              echo "failed_sites.json not found."
            fi
            echo
            if [ -f "签到账户/NEWAPI_ACCOUNTS.json" ]; then
              echo "### NEWAPI Accounts Export"
              echo "export_file: 签到账户/NEWAPI_ACCOUNTS.json"
              python -c "import json; from pathlib import Path; p=Path('签到账户/NEWAPI_ACCOUNTS.json'); data=json.loads(p.read_text(encoding='utf-8')); print(f'export_count: {len(data) if isinstance(data, list) else 0}')"
            else
              echo "### NEWAPI Accounts Export"
              echo "NEWAPI_ACCOUNTS export file not found."
            fi
            echo
            echo "### Key Log Lines"
            grep -E "LDOH|站点可用性过滤|签到结束|OAuth 网络不可达|WinError 1225" run_newapi.log | tail -n 40 || true
            echo
            echo "### Error/Warning Snapshot"
            grep -E "ERROR|WARNING|Cloudflare|401|403|429|Timeout|超时|OAuth" run_newapi.log | tail -n 120 || true
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Commit reports (failed sites / optional NEWAPI export)
        if: always()
        env:
          NEWAPI_EXPORT_COMMIT_ENABLED: ${{ vars.NEWAPI_EXPORT_COMMIT_ENABLED || 'false' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          CHANGED=0
          if [ -f scripts/chrome_extension/failed_sites.json ]; then
            git add scripts/chrome_extension/failed_sites.json
            CHANGED=1
          else
            echo "failed_sites.json not found, skip failed-sites commit."
          fi

          if [ "${NEWAPI_EXPORT_COMMIT_ENABLED}" = "true" ] && [ -f "签到账户/NEWAPI_ACCOUNTS.json" ]; then
            # 签到账户目录在 .gitignore 中，需强制 add
            git add -f "签到账户/NEWAPI_ACCOUNTS.json"
            CHANGED=1
          else
            echo "NEWAPI export commit disabled or file missing (set repo variable NEWAPI_EXPORT_COMMIT_ENABLED=true to enable)."
          fi

          if [ "$CHANGED" -eq 0 ]; then
            echo "No report file to commit."
            exit 0
          fi

          if git diff --cached --quiet; then
            echo "No report changes to commit."
            exit 0
          fi

          git commit -m "chore: sync newapi reports [skip ci]"
          git pull --rebase origin "${GITHUB_REF_NAME}" || true
          git push origin "HEAD:${GITHUB_REF_NAME}" || true

      - name: Upload runtime log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: run-newapi-log
          path: run_newapi.log
          retention-days: 3
          if-no-files-found: ignore

      - name: Upload NEWAPI accounts export
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: newapi-accounts-export
          path: "签到账户/NEWAPI_ACCOUNTS.json"
          retention-days: 3
          if-no-files-found: ignore

      # 上传 Debug 截图（仅在 debug 模式下）
      - name: Upload debug screenshots
        if: ${{ github.event.inputs.debug == 'true' && always() }}
        uses: actions/upload-artifact@v4
        with:
          name: debug-screenshots
          path: debug_screenshots/
          retention-days: 3
          if-no-files-found: ignore

      # 清理旧的工作流运行记录
      - name: Delete workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 10
          keep_minimum_runs: 6
